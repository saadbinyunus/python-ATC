<!DOCTYPE html>
<html>
<head>
    <title>YYZ ATC Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .runway { padding: 10px; margin: 5px; border: 1px solid #ccc; }
        .AVAILABLE { background-color: #d4edda; }
        .OCCUPIED { background-color: #f8d7da; }
        .MAINTENANCE { background-color: #fff3cd; }
        .logs { grid-column: span 2; border-top: 1px solid #eee; padding-top: 20px; max-height: 300px; overflow-y: auto; }
        .log-entry { padding: 5px; border-bottom: 1px solid #eee; }
        .log-entry.error { color: #721c24; background-color: #f8d7da; border-left: 3px solid #dc3545; }
        .log-entry.success { color: #155724; background-color: #d4edda; border-left: 3px solid #28a745; }
        .log-entry.warning { color: #856404; background-color: #fff3cd; border-left: 3px solid #ffc107; }
        .queue { border: 1px solid #ddd; padding: 10px; }
        .aircraft { margin: 5px; padding: 5px; border: 1px solid #eee; }
        .status-badge { 
            display: inline-block; 
            padding: 2px 5px; 
            border-radius: 3px; 
            font-size: 0.8em;
            color: white;
        }
        .ENROUTE { background-color: #007bff; }
        .HOLDING { background-color: #ffc107; color: black; }
        .LANDING { background-color: #28a745; }
        .LANDED { background-color: #6c757d; }
        .TAKEOFF { background-color: #17a2b8; }
        .DEPARTED { background-color: #343a40; }
        .GO_AROUND { background-color: #dc3545; }
        .DELAYED { background-color: #fd7e14; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Toronto Pearson (YYZ) ATC Dashboard</h1>
        <div class="dashboard">
            <div class="runways">
                <h2>Runways</h2>
                <div id="runway-status"></div>
            </div>
            
            <div class="queues">
                <div class="queue">
                    <h3>Landing Queue</h3>
                    <ol id="landing-queue"></ol>
                </div>
                <div class="queue">
                    <h3>Takeoff Queue</h3>
                    <ol id="takeoff-queue"></ol>
                </div>
            </div>
            
            <div class="aircrafts">
                <h3>Aircraft Status</h3>
                <div id="aircraft-status"></div>
            </div>
            
            <div class="logs">
                <h3>ATC Logs</h3>
                <div id="atc-logs"></div>
            </div>
        </div>
    </div>

    <script>
        let socket;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const RECONNECT_DELAY = 5000;
        
        function connect() {
            socket = new WebSocket('ws://localhost:6789');
            
            socket.onopen = () => {
                reconnectAttempts = 0;
                addLog("Connected to ATC server", "success");
            };
            
            socket.onclose = () => {
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    addLog(`Disconnected. Attempting to reconnect (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`, "warning");
                    setTimeout(connect, RECONNECT_DELAY);
                } else {
                    addLog("Max reconnection attempts reached. Please refresh the page.", "error");
                }
            };
            
            socket.onerror = (error) => {
                addLog(`WebSocket error: ${error.message || 'Unknown error'}`, "error");
            };
            
            socket.onmessage = (event) => {
                try {
                    updateDashboard(JSON.parse(event.data));
                } catch (error) {
                    addLog(`Error parsing message: ${error.message}`, "error");
                }
            };
        }
        
        function addLog(message, type = "info") {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            const logsContainer = document.getElementById('atc-logs');
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function updateDashboard(data) {
            // Update runways
            document.getElementById('runway-status').innerHTML = data.runways.map(runway => `
                <div class="runway ${runway.status}">
                    <strong>Runway ${runway.id}</strong> (${runway.length}m)<br>
                    ${runway.current_operation ? runway.current_operation.toUpperCase() : 'IDLE'}<br>
                    ${runway.current_aircraft ? `Aircraft: ${runway.current_aircraft}` : ''}
                </div>
            `).join('');
            
            // Update queues
            document.getElementById('landing-queue').innerHTML = 
                data.landing_queue.map(flight => `<li>${flight}</li>`).join('') || '<li>Empty</li>';
            
            document.getElementById('takeoff-queue').innerHTML = 
                data.takeoff_queue.map(flight => `<li>${flight}</li>`).join('') || '<li>Empty</li>';
            
            // Update aircrafts
            document.getElementById('aircraft-status').innerHTML = 
                data.aircrafts.map(ac => `
                    <div class="aircraft">
                        <strong>${ac.flight_number}</strong> 
                        (${getSizeName(ac.size)})<br>
                        <span class="status-badge ${ac.status}">${ac.status}</span><br>
                        ${ac.runway_assigned ? `Assigned to Runway ${ac.runway_assigned}<br>` : ''}
                        ${ac.delay ? `Delay: ${ac.delay} min` : ''}
                    </div>
                `).join('') || '<div>No active aircraft</div>';
            
            // Update logs
            const newLogs = data.logs.map(log => `<div class="log-entry">${log}</div>`).join('');
            document.getElementById('atc-logs').innerHTML = newLogs;
        }

        function getSizeName(size) {
            const sizes = {1: 'SMALL', 2: 'MEDIUM', 3: 'LARGE'};
            return sizes[size] || 'UNKNOWN';
        }

        // Initialize connection
        connect();

        // Test aircraft generator (uncomment to enable)
        /*
        function generateTestAircraft() {
            if (socket.readyState !== WebSocket.OPEN) return;
            
            const flightNumber = 'AC' + Math.floor(Math.random() * 1000);
            const size = Math.floor(Math.random() * 3) + 1;
            
            fetch(`http://localhost:50051/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/grpc',
                },
                body: JSON.stringify({
                    flight_number: flightNumber,
                    size: size
                })
            }).catch(error => {
                addLog(`Error sending test aircraft: ${error.message}`, "error");
            });
        }
        setInterval(generateTestAircraft, 15000);
        */
    </script>
</body>
</html>